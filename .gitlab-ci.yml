image: mingc/android-build-box:latest

stages:
  - cloneRepo
  - codeFormatter
  - test
  - buildAndDistribute

cache:
  key: cache-key
  paths:
    - .gradle/

variables:
  FIREBASE_TOKEN: "$FIREBASE_TOKEN_ID"
  ENABLE_CODE_FORMATTER: "false"
  ENABLE_UNIT_TEST: "false"

cloneRepository:
  stage: cloneRepo
  script:
    - git clone https://gitlab.com/sedayux/ocean-skeleton.git
    - cd ocean-skeleton
    - git submodule sync
    - git submodule update --init --recursive
    - git status

assembleDevDebug:
  stage: buildAndDistribute
  script:
    - icacls .\gradlew /grant Everyone:RX
    - ./gradlew --no-daemon --console=plain assembleDevDebug appDistributionUploadDevDebug --parallel --no-build-cache
  artifacts:
    expire_in: 1 day
    paths:
      - skeleton-app/build/outputs/apk/dev/debug/skeleton-app-dev-debug.apk
  when: manual

assembleSitDebug:
  stage: buildAndDistribute
  script:
    - icacls .\gradlew /grant Everyone:RX
    - ./gradlew --no-daemon --console=plain assembleSitDebug appDistributionUploadSitDebug --parallel --no-build-cache
  artifacts:
    expire_in: 1 day
    paths:
      - skeleton-app/build/outputs/apk/sit/debug/skeleton-app-sit-debug.apk
  only:
    - development
    - /^feature\/.*\/master$/

assembleUatDebug:
  stage: buildAndDistribute
  script:
    - icacls .\gradlew /grant Everyone:RX
    - ./gradlew --no-daemon --console=plain assembleUatDebug appDistributionUploadUatDebug --parallel --no-build-cache
  artifacts:
    expire_in: 1 day
    paths:
      - skeleton-app/build/outputs/apk/uat/debug/skeleton-app-uat-debug.apk
  only:
    - /^uat.*$/


codeFormatterCheck:
  stage: codeFormatter
  script:
    - |
      if ($env:ENABLE_CODE_FORMATTER -eq "true") {
       ./gradlew spotlessCheck
       ./gradlew detekt
      } else {
       Write-Host "Skipping codeFormatterCheck"
      }


unitTest:
  stage: test
  script:
    - |
      if ($env:ENABLE_UNIT_TEST -eq "true") {
       ./gradlew test
      } else {
       Write-Host "Skipping unitTest"
      }